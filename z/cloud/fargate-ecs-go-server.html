<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Implementing a Go HTTP Server and Websocket with Fargate and ECR</title></head><body><article class="page serif"><header><div class="page-header-icon undefined"><img class="icon" src="https://icon.icepanel.io/AWS/svg/Compute/Fargate.svg"/></div><h1 class="page-title">Implementing a Go HTTP Server and Websocket with Fargate and ECR</h1><p class="page-description"></p><table class="properties"><tbody><tr class="property-row property-row-created_by"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesCreatedBy"><path d="M8 15.126C11.8623 15.126 15.0615 11.9336 15.0615 8.06445C15.0615 4.20215 11.8623 1.00293 7.99316 1.00293C4.13086 1.00293 0.938477 4.20215 0.938477 8.06445C0.938477 11.9336 4.1377 15.126 8 15.126ZM8 10.4229C6.05176 10.4229 4.54785 11.1133 3.83008 11.9131C2.90039 10.9082 2.33301 9.55469 2.33301 8.06445C2.33301 4.91992 4.84863 2.39746 7.99316 2.39746C11.1377 2.39746 13.6738 4.91992 13.6738 8.06445C13.6738 9.55469 13.1064 10.9082 12.1699 11.9131C11.4521 11.1133 9.94824 10.4229 8 10.4229ZM8 9.30176C9.32617 9.30859 10.3516 8.18066 10.3516 6.71094C10.3516 5.33008 9.31934 4.18164 8 4.18164C6.6875 4.18164 5.6416 5.33008 5.64844 6.71094C5.65527 8.18066 6.68066 9.28809 8 9.30176Z"></path></svg></span>Created by</th><td><span class="user"><img src="Implementing%20a%20Go%20HTTP%20Server%20and%20Websocket%20with%20F%20aa4c7620247c47b0ba3252c82bcb5a39/IMG_2295.jpg" class="icon user-icon"/>JiaLin Huang</span></td></tr><tr class="property-row property-row-last_edited_time"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesCreatedAt"><path d="M8 15.126C11.8623 15.126 15.0615 11.9336 15.0615 8.06445C15.0615 4.20215 11.8623 1.00293 7.99316 1.00293C4.13086 1.00293 0.938477 4.20215 0.938477 8.06445C0.938477 11.9336 4.1377 15.126 8 15.126ZM8 13.7383C4.85547 13.7383 2.33301 11.209 2.33301 8.06445C2.33301 4.91992 4.84863 2.39746 7.99316 2.39746C11.1377 2.39746 13.6738 4.91992 13.6738 8.06445C13.6738 11.209 11.1445 13.7383 8 13.7383ZM4.54102 8.91211H7.99316C8.30078 8.91211 8.54004 8.67285 8.54004 8.37207V3.8877C8.54004 3.58691 8.30078 3.34766 7.99316 3.34766C7.69238 3.34766 7.45312 3.58691 7.45312 3.8877V7.83203H4.54102C4.2334 7.83203 4.00098 8.06445 4.00098 8.37207C4.00098 8.67285 4.2334 8.91211 4.54102 8.91211Z"></path></svg></span>Last edited</th><td><time>@2024年9月29日 10:00</time></td></tr><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesMultipleSelect"><path d="M1.91602 4.83789C2.44238 4.83789 2.87305 4.40723 2.87305 3.87402C2.87305 3.34766 2.44238 2.91699 1.91602 2.91699C1.38281 2.91699 0.952148 3.34766 0.952148 3.87402C0.952148 4.40723 1.38281 4.83789 1.91602 4.83789ZM5.1084 4.52344H14.3984C14.7607 4.52344 15.0479 4.23633 15.0479 3.87402C15.0479 3.51172 14.7607 3.22461 14.3984 3.22461H5.1084C4.74609 3.22461 4.45898 3.51172 4.45898 3.87402C4.45898 4.23633 4.74609 4.52344 5.1084 4.52344ZM1.91602 9.03516C2.44238 9.03516 2.87305 8.60449 2.87305 8.07129C2.87305 7.54492 2.44238 7.11426 1.91602 7.11426C1.38281 7.11426 0.952148 7.54492 0.952148 8.07129C0.952148 8.60449 1.38281 9.03516 1.91602 9.03516ZM5.1084 8.7207H14.3984C14.7607 8.7207 15.0479 8.43359 15.0479 8.07129C15.0479 7.70898 14.7607 7.42188 14.3984 7.42188H5.1084C4.74609 7.42188 4.45898 7.70898 4.45898 8.07129C4.45898 8.43359 4.74609 8.7207 5.1084 8.7207ZM1.91602 13.2324C2.44238 13.2324 2.87305 12.8018 2.87305 12.2686C2.87305 11.7422 2.44238 11.3115 1.91602 11.3115C1.38281 11.3115 0.952148 11.7422 0.952148 12.2686C0.952148 12.8018 1.38281 13.2324 1.91602 13.2324ZM5.1084 12.918H14.3984C14.7607 12.918 15.0479 12.6309 15.0479 12.2686C15.0479 11.9062 14.7607 11.6191 14.3984 11.6191H5.1084C4.74609 11.6191 4.45898 11.9062 4.45898 12.2686C4.45898 12.6309 4.74609 12.918 5.1084 12.918Z"></path></svg></span>Tags</th><td><span class="selected-value select-value-color-purple">Post</span><span class="selected-value select-value-color-red">aws</span><span class="selected-value select-value-color-gray">ecr</span><span class="selected-value select-value-color-yellow">ecs</span><span class="selected-value select-value-color-pink">elb</span><span class="selected-value select-value-color-blue">fargate</span><span class="selected-value select-value-color-default">golang</span><span class="selected-value select-value-color-brown">route53</span></td></tr></tbody></table></header><div class="page-body"><p class="">
</p><div class="column-list"><div style="width:20%" class="column"><figure class="image"><a href="https://icon.icepanel.io/AWS/svg/Compute/Fargate.svg"><img src="https://icon.icepanel.io/AWS/svg/Compute/Fargate.svg"/></a></figure></div><div style="width:20%" class="column"><figure class="image"><a href="https://icon.icepanel.io/AWS/svg/Containers/Elastic-Container-Registry.svg"><img src="https://icon.icepanel.io/AWS/svg/Containers/Elastic-Container-Registry.svg"/></a></figure></div><div style="width:20%" class="column"><figure class="image"><a href="https://icon.icepanel.io/AWS/svg/Containers/Elastic-Container-Service.svg"><img src="https://icon.icepanel.io/AWS/svg/Containers/Elastic-Container-Service.svg"/></a></figure></div><div style="width:20%" class="column"><figure class="image"><a href="https://icon.icepanel.io/AWS/svg/Networking-Content-Delivery/Elastic-Load-Balancing.svg"><img src="https://icon.icepanel.io/AWS/svg/Networking-Content-Delivery/Elastic-Load-Balancing.svg"/></a></figure></div><div style="width:20%" class="column"><figure class="image"><a href="https://icon.icepanel.io/AWS/svg/Networking-Content-Delivery/Route-53.svg"><img src="https://icon.icepanel.io/AWS/svg/Networking-Content-Delivery/Route-53.svg"/></a></figure></div></div><p class="">
</p><p class="">This article explores <mark class="highlight-blue"><strong>AWS Elastic Container Service (ECS)</strong></mark>, focusing on <mark class="highlight-blue"><strong>Fargate</strong></mark> and <mark class="highlight-blue"><strong>ECR</strong></mark>. While we use a simple Go HTTP server as an example, our main goal is to understand <mark class="highlight-blue"><strong>ECS</strong></mark> deployment processes. The Golang code serves just as a vehicle to create a basic container image. We&#x27;ll cover key steps from local development to cloud deployment, highlighting the intricacies of AWS container services.</p><p class="">
</p><h1 class="">If You Know About Docker (It&#x27;s Super Simple!)</h1><p class="">You simply upload your image to Docker, pull it down when needed, and can also pull other software you need, then docker run.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-Bash">docker build -t my-app .
docker tag my-app:latest 123456789.dkr.ecr.us-west-2.amazonaws.com/my-app:latest
docker push 123456789.dkr.ecr.us-west-2.amazonaws.com/my-app:latest</code></pre><p class="">Similarly, above is aws version of docker flow.</p><p class="">After that: two more step for serving your image.</p><ol type="1" class="numbered-list" start="1"><li>Create a Task Definition in ECS:<p class="">Link Specify the ECR image: 123456789.dkr.ecr.us-west-2.amazonaws.com/my-app:latest</p></li></ol><ol type="1" class="numbered-list" start="2"><li>Launch a Service or Task and choose the task definition (docker run)</li></ol><p class=""><mark class="highlight-red"><strong>Done!</strong></mark></p><p class="">
</p><p class="">
</p><h1 class="">Go Build Configuration Notes</h1><p class="">Just a super normal Dockerfile here. And we gonna talk about why need these options:</p><ol type="1" class="numbered-list" start="1"><li><code>CGO_ENABLED</code></li></ol><ol type="1" class="numbered-list" start="2"><li><code>GOARCH</code></li></ol><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-Docker"># first
FROM golang:1.22 AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo -o main .

# then
FROM alpine:latest  
RUN apk --no-cache add ca-certificates
WORKDIR /root/

# get result from the first stage.
COPY --from=builder /app/main .

CMD [&quot;./main&quot;]</code></pre><h3 class="">WHY need <code>CGO_ENABLED=0</code> ?</h3><p class="">This means &quot;No C library, I use my OWN Go implementation for lower layer&quot;</p><p class="">Go will use its own pure Go implementation to handle low-level operations.</p><p class="">Not relying on the system&#x27;s C library reduces problems <mark class="highlight-red">caused by different versions of C libraries on different systems.</mark></p><ul class="bulleted-list"><li style="list-style-type:disc">The Go compiler will use the language&#x27;s built-in cross-platform abstraction layer.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">These abstraction layers have specific implementations on different operating systems, ensuring cross-platform compatibility.</li></ul><p class=""><strong>However, in scenarios that rely more on low-level interactions, it might be preferable to use true.</strong></p><p class="">Building the image might increase the file size a bit, but it gains higher cross-platform compatibility.</p><p class="">
</p><h3 class="">Why need <code>GOARCH=amd64</code> ?</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-Docker">RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# v.s.
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo -o main .</code></pre><p class="">This is because when creating a Task Definition in ECS, you&#x27;ll be asked to choose the Operating system/Architecture. You&#x27;ll find that ECS Fargate itself has architectural limitations.</p><figure class="image" style="text-align:left"><a href="/z/cloud/fargate-ecs-go-server.png"><img style="width:384px" src="/z/cloud/fargate-ecs-go-server.png"/></a></figure><p class="">You can try it out. If you don&#x27;t specify <code>GOARCH</code> during go build, when you try to run a new task using this image, it will cause an <code>exec ./main: exec format error</code>.</p><p class="">
</p><p class="">
</p><p class="">
</p><p class="">
</p><p class="">
</p><p class="">
</p><h1 class="">Findings and Thoughts</h1><h3 class="">Question 1: Capacity Provider Strategy vs. Launch Type</h3><p class=""><strong>Launch Type</strong></p><p class="">Intuitive. It&#x27;s simply choosing whether you want to add a Fargate, EC2, or Fargate SPOT instance.</p><p class=""><mark class="highlight-blue"><strong>Nothing to concern about this selection.</strong></mark></p><p class="">
</p><p class=""><strong>Capacity Provider Strategy (more complicated)</strong></p><p class="">You can configure whether to use Fargate or Fargate Spot yourself.</p><p class="">The pricing is EC2 &gt; Fargate &gt; Fargate Spot, of course, Fargate Spot comes with the risk of potential interruptions. </p><p class="">(Similar to EC2 having on-demand &gt; reserved instance &gt; spot instance, you make cost configurations based on your needs)</p><p class="">Note that when combining Fargate/Fargate Spot, there are two parameters we should know: </p><ol type="1" class="numbered-list" start="1"><li><code>base</code>: the <code>base</code> of one of them should remain 0. </li></ol><ol type="1" class="numbered-list" start="2"><li><code>weight</code>: mechanism actually works like this</li></ol><ul class="bulleted-list"><li style="list-style-type:disc">First, it satisfies the <code>base</code> requirements of all Capacity Providers.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">The remaining tasks are then distributed according to the <code>weight</code> ratio.</li></ul><p class="">For example, let&#x27;s say we have a strategy with two providers:</p><p class="">If we need to run 12 tasks:</p><table class="simple-table"><tbody><tr><td class="">Unit</td><td class="">Fargate</td><td class="">Fargate Spot</td></tr><tr><td class="">base</td><td class="">3</td><td class="">0</td></tr><tr><td class="">weight</td><td class="">1</td><td class="">2</td></tr><tr><td class="block-color-orange_background">result</td><td class="block-color-orange_background">6 (3+3)</td><td class="block-color-orange_background">6 (0+6)</td></tr></tbody></table><ol type="1" class="numbered-list" start="1"><li>First, it fulfills the base: 3 task goes to Fargate.</li></ol><ol type="1" class="numbered-list" start="2"><li>For the remaining 9 tasks, it uses the weight ratio (1:2)</li></ol><p class="">This strategy allows you to balance cost optimization (using more Spot instances) with stability (ensuring a base on regular Fargate).”</p><p class="">
</p><p class=""><strong>The impact of Capacity Provider Strategy on the next step:</strong></p><ul class="bulleted-list"><li style="list-style-type:disc">For Tasks, it mainly affects how many resources are initially placed where, like 70% for FARGATE SPOT and 30% for FARGATE. Tasks themselves don&#x27;t Auto Scale based on conditions.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">For Services, it determines the initial resource placement and will expand or contract as needed.</li></ul><p class="">In simple terms, it has no effect on Tasks. For Service, it only knows how many units to add or remobe based on auto-scaling decisions, and then <mark class="highlight-blue"><strong>uses the initial Capacity Provider Strategy to make the final compute resource allocation.</strong></mark></p><p class="">
</p><h3 class="">Question 2: Decide to run Service or Task?</h3><p class="">If you need to integrate with other services, require long-running operations, or need load balancing, auto-scaling, microservice architecture, etc., choose Service.<br/><br/></p><p class="">Tasks are more suitable for cronjobs, batch processing, one-time processing, build tasks in CI/CD workflows, and other short-term, on-demand scenarios.</p><p class="">
</p><p class="">
</p><p class="">
</p><h3 class="">Question 3: Capacity Provider Strategy vs. ALB - Are They Similar?</h3><p class=""><strong>Capacity Provider Strategy has a traffic-like function similar to ALB</strong>, but if you want more fine-grained management or more comprehensive features, it&#x27;s recommended to use ALB.</p><p class="">When should you use ALB:</p><ol type="1" class="numbered-list" start="1"><li>When you need SSL binding or high integration with other AWS services.</li></ol><ol type="1" class="numbered-list" start="2"><li>When you don&#x27;t want others to directly access the task&#x27;s public IP, and you want your product to be more elegant. You only want to expose the ALB DNS to the outside, especially considering that task IPs may not be fixed.</li></ol><p class="">
</p><p class="">Of course, ECS can be linked with ALB when adding tasks, but how do they work?</p><p class="">The communication between ECS and ALB is based on the <mark class="highlight-red"><strong>intermediate target group</strong></mark>. ALB itself can correspond to one or more target groups to distinguish, for example:</p><ul class="bulleted-list"><li style="list-style-type:disc">domain.app/api → go target group <code>backend</code></li></ul><ul class="bulleted-list"><li style="list-style-type:disc">domain.app/root → go target group <code>landing-page</code>.</li></ul><p class="">It matches the services under the target group according to my path situation.</p><p class="">When creating a Service in ECS, the Load Balancing settings section will tell you that you can assign a target group for this service, which is the step that registers tasks to ALB.</p><p class="">
</p><p class="">
</p><p class="">
</p><p class="">
</p><h3 class="">Thought 1: ECS Task Definition vs. EC2 AMI, Both Seem Like Blueprints</h3><p class="">Indeed, both define the work content in advance, but the difference is that Task Definition doesn&#x27;t have as large a management scope as EC2 AMI. EC2 AMI involves requirements for systems, processes, and resource configurations to facilitate future machine startup. Task Definition covers less and has simpler options.</p><p class="">Task Definition is for containers, EC2 AMI is for VMs.</p><p class="">Task definition is faster, allows for more granular resource allocation, and launches corresponding compute resources more quickly.</p><p class=""><mark class="highlight-red">Task definition </mark><mark class="highlight-red"><strong>must be created</strong></mark><mark class="highlight-red"> before creating a service or task, <br/><br/></mark>but AMI is not necessary to create your own instance.</p><p class="">
</p><p class="">
</p><p class="">
</p><p class="">
</p><h3 class=""><mark class="highlight-red">Thought 2: ECS Running Task or Service Are Just UX Things</mark></h3><p class="">Whether you choose to Create Service or Run new Task at the beginning, entering the panel and changing to task or services, it doesn&#x27;t seem to matter which button you click to enter. It just presets based on where you came from.<br/>The settings are almost the same, only differing in optional features. For example, if you choose Task, you won&#x27;t have Auto Scaling and ALB functions. I think this design of service or task is just for user perception.<br/>Even when adding a Task Definition, the initial options don&#x27;t have to be followed strictly. For example:<br/></p><p class=""><mark class="highlight-red"><strong>Example 1:</strong></mark> Found that if my Task Definition is selected as Instance for Launch type. </p><p class="">But when deciding to launch (Task or Service), you can also choose Fargate as the Launch type.</p><p class="">It won&#x27;t care if your choice matches the bound Task Definition.</p><p class=""><mark class="highlight-red"><strong>Example 2:</strong></mark> If I use the add service method to execute a task, say 3 replicas, but once it actually starts, those three replicas will correspond to three newly added tasks.</p><p class=""><strong>It&#x27;s worth considering that tasks are the actual running units, while services are more like logical abstractions, similar to k8s Service resources</strong></p><table class="simple-table"><tbody><tr><td class="">ECS Unit</td><td class="">Kubernetes Unit</td></tr><tr><td class="">Task</td><td class="">Pod</td></tr><tr><td class="">Service</td><td class="">Service</td></tr></tbody></table><p class="">For AWS, it&#x27;s all about creating compute resources in the end, so no matter how complex or confusing the frontend might be, there&#x27;s not much to worry about.</p><p class="">
</p><h3 class="">Thought 3: Maybe we can do better</h3><p class="">If you want a nicer domain name, you can choose Route53 to point directly to the ALB DNS. And you can just simple put your Certificate on your ALB.</p><ol type="1" class="numbered-list" start="1"><li>add an HTTPS listener on port 443 and attach &quot;your domain&quot; certificate.</li></ol><ol type="1" class="numbered-list" start="2"><li>configure the HTTP listener on port 80 to redirect to HTTPS. </li></ol><ol type="1" class="numbered-list" start="3"><li>set up Route53 by creating an A record alias for &quot;your domain&quot; pointing to your ALB&#x27;s DNS name.</li></ol><p class="">That&#x27;s it, you&#x27;re done. <mark class="highlight-red"><strong>You get a nicer domain name and HTTPS!</strong></mark> </p><p class="">
</p><p class="">
</p><h1 class="">Reference</h1><p class=""><a href="https://stackoverflow.com/questions/73285601/docker-exec-usr-bin-sh-exec-format-error">https://stackoverflow.com/questions/73285601/docker-exec-usr-bin-sh-exec-format-error</a></p><p class=""><a href="https://docs.docker.com/build/building/multi-platform/">https://docs.docker.com/build/building/multi-platform/</a></p><p class=""><a href="https://gist.github.com/asukakenji/f15ba7e588ac42795f421b48b8aede63">https://gist.github.com/asukakenji/f15ba7e588ac42795f421b48b8aede63</a></p><p class=""><a href="https://dev.to/metal3d/understand-how-to-use-c-libraries-in-go-with-cgo-3dbn">https://dev.to/metal3d/understand-how-to-use-c-libraries-in-go-with-cgo-3dbn</a></p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body>