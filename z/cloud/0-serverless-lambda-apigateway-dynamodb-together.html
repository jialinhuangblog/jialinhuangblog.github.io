<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Serverless: Lambda, API Gateway, DynamoDB Together</title></head><body><article class="page serif"><header><div class="page-header-icon undefined"><img class="icon" src="https://icon.icepanel.io/AWS/svg/App-Integration/API-Gateway.svg"/></div><h1 class="page-title">Serverless: Lambda, API Gateway, DynamoDB Together</h1><p class="page-description"></p><table class="properties"><tbody><tr class="property-row property-row-created_by"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesCreatedBy"><path d="M8 15.126C11.8623 15.126 15.0615 11.9336 15.0615 8.06445C15.0615 4.20215 11.8623 1.00293 7.99316 1.00293C4.13086 1.00293 0.938477 4.20215 0.938477 8.06445C0.938477 11.9336 4.1377 15.126 8 15.126ZM8 10.4229C6.05176 10.4229 4.54785 11.1133 3.83008 11.9131C2.90039 10.9082 2.33301 9.55469 2.33301 8.06445C2.33301 4.91992 4.84863 2.39746 7.99316 2.39746C11.1377 2.39746 13.6738 4.91992 13.6738 8.06445C13.6738 9.55469 13.1064 10.9082 12.1699 11.9131C11.4521 11.1133 9.94824 10.4229 8 10.4229ZM8 9.30176C9.32617 9.30859 10.3516 8.18066 10.3516 6.71094C10.3516 5.33008 9.31934 4.18164 8 4.18164C6.6875 4.18164 5.6416 5.33008 5.64844 6.71094C5.65527 8.18066 6.68066 9.28809 8 9.30176Z"></path></svg></span>Created by</th><td><span class="user"><img src="Serverless%20Lambda,%20API%20Gateway,%20DynamoDB%20Together%20258f5287d30240eda21d99126edd3584/IMG_2295.jpg" class="icon user-icon"/>JiaLin Huang</span></td></tr><tr class="property-row property-row-last_edited_time"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesCreatedAt"><path d="M8 15.126C11.8623 15.126 15.0615 11.9336 15.0615 8.06445C15.0615 4.20215 11.8623 1.00293 7.99316 1.00293C4.13086 1.00293 0.938477 4.20215 0.938477 8.06445C0.938477 11.9336 4.1377 15.126 8 15.126ZM8 13.7383C4.85547 13.7383 2.33301 11.209 2.33301 8.06445C2.33301 4.91992 4.84863 2.39746 7.99316 2.39746C11.1377 2.39746 13.6738 4.91992 13.6738 8.06445C13.6738 11.209 11.1445 13.7383 8 13.7383ZM4.54102 8.91211H7.99316C8.30078 8.91211 8.54004 8.67285 8.54004 8.37207V3.8877C8.54004 3.58691 8.30078 3.34766 7.99316 3.34766C7.69238 3.34766 7.45312 3.58691 7.45312 3.8877V7.83203H4.54102C4.2334 7.83203 4.00098 8.06445 4.00098 8.37207C4.00098 8.67285 4.2334 8.91211 4.54102 8.91211Z"></path></svg></span>Last edited</th><td><time>@2024年9月29日 10:30</time></td></tr><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesMultipleSelect"><path d="M1.91602 4.83789C2.44238 4.83789 2.87305 4.40723 2.87305 3.87402C2.87305 3.34766 2.44238 2.91699 1.91602 2.91699C1.38281 2.91699 0.952148 3.34766 0.952148 3.87402C0.952148 4.40723 1.38281 4.83789 1.91602 4.83789ZM5.1084 4.52344H14.3984C14.7607 4.52344 15.0479 4.23633 15.0479 3.87402C15.0479 3.51172 14.7607 3.22461 14.3984 3.22461H5.1084C4.74609 3.22461 4.45898 3.51172 4.45898 3.87402C4.45898 4.23633 4.74609 4.52344 5.1084 4.52344ZM1.91602 9.03516C2.44238 9.03516 2.87305 8.60449 2.87305 8.07129C2.87305 7.54492 2.44238 7.11426 1.91602 7.11426C1.38281 7.11426 0.952148 7.54492 0.952148 8.07129C0.952148 8.60449 1.38281 9.03516 1.91602 9.03516ZM5.1084 8.7207H14.3984C14.7607 8.7207 15.0479 8.43359 15.0479 8.07129C15.0479 7.70898 14.7607 7.42188 14.3984 7.42188H5.1084C4.74609 7.42188 4.45898 7.70898 4.45898 8.07129C4.45898 8.43359 4.74609 8.7207 5.1084 8.7207ZM1.91602 13.2324C2.44238 13.2324 2.87305 12.8018 2.87305 12.2686C2.87305 11.7422 2.44238 11.3115 1.91602 11.3115C1.38281 11.3115 0.952148 11.7422 0.952148 12.2686C0.952148 12.8018 1.38281 13.2324 1.91602 13.2324ZM5.1084 12.918H14.3984C14.7607 12.918 15.0479 12.6309 15.0479 12.2686C15.0479 11.9062 14.7607 11.6191 14.3984 11.6191H5.1084C4.74609 11.6191 4.45898 11.9062 4.45898 12.2686C4.45898 12.6309 4.74609 12.918 5.1084 12.918Z"></path></svg></span>Tags</th><td><span class="selected-value select-value-color-purple">Post</span><span class="selected-value select-value-color-green">api-gateway</span><span class="selected-value select-value-color-red">aws</span><span class="selected-value select-value-color-brown">dynamoDB</span><span class="selected-value select-value-color-default">lambda</span></td></tr></tbody></table></header><div class="page-body"><p class="">
</p><p class=""><a href="https://aws.amazon.com/tw/serverless/">https://aws.amazon.com/tw/serverless/</a></p><p class="">All services mentioned are belonging to serverless</p><div class="column-list"><div style="width:20.833333333333332%" class="column"><figure class="image"><a href="https://icon.icepanel.io/AWS/svg/App-Integration/API-Gateway.svg"><img src="https://icon.icepanel.io/AWS/svg/App-Integration/API-Gateway.svg"/></a></figure></div><div style="width:20.833333333333332%" class="column"><figure class="image" style="text-align:left"><a href="https://icon.icepanel.io/AWS/svg/Compute/Lambda.svg"><img src="https://icon.icepanel.io/AWS/svg/Compute/Lambda.svg"/></a></figure></div><div style="width:58.33333333333335%" class="column"><figure class="image" style="text-align:left"><a href="https://icon.icepanel.io/AWS/svg/Database/DynamoDB.svg"><img src="https://icon.icepanel.io/AWS/svg/Database/DynamoDB.svg"/></a></figure></div></div><h1 class="">WHY</h1><p class="">you don&#x27;t need to launch an entire backend project. You can simply upload a single file (like an index.js) to get your function running. This dramatically simplifies the deployment process and reduces the complexity of managing <strong>dirty</strong> server infrastructure.</p><p class="">Instead of spending time on server configuration and management tasks, we Developers can focus on coding that directly related to our main goal.</p><p class="">
</p><h1 class="">Here&#x27;s what we&#x27;re going to do</h1><ol type="1" class="numbered-list" start="1"><li>When a user sends a request through our <mark class="highlight-blue"><strong>API Gateway</strong></mark>, it&#x27;s like ringing a bell.</li></ol><ol type="1" class="numbered-list" start="2"><li>This &quot;bell&quot; wakes up <mark class="highlight-blue"><strong>Lambda</strong></mark> to handle the task.</li></ol><ol type="1" class="numbered-list" start="3"><li>It might be checking on a user&#x27;s order status or saving a new review to our <mark class="highlight-blue"><strong>DynamoDB</strong></mark> database.</li></ol><ol type="1" class="numbered-list" start="4"><li>Once <mark class="highlight-blue"><strong>Lambda</strong></mark>&#x27;s done its job, it return the results and sends them back to the client through the <mark class="highlight-blue"><strong>API Gateway</strong></mark>.</li></ol><h1 class="">Step 1: Create a DynamoDB table for Later Usage</h1><p class="">Just go create a table</p><p class="">Nothing to care.</p><h1 class="">Step 2: Create a Lambda Function</h1><ol type="1" class="numbered-list" start="1"><li><mark class="highlight-blue"><strong>Lambda</strong></mark> &gt; Create function.</li></ol><ol type="1" class="numbered-list" start="2"><li>Pick your flavor - from scratch or use a blueprint.<ol type="a" class="numbered-list" start="1"><li>if you choose from scratch, then upload your code.</li></ol></li></ol><ol type="1" class="numbered-list" start="3"><li>Name it and choose your language.</li></ol><ol type="1" class="numbered-list" start="4"><li>Set up permissions.<ol type="a" class="numbered-list" start="1"><li>need do make new role attach some DynamoDB policies later<ol type="i" class="numbered-list" start="1"><li>like <code>AmazonDynamoDBFullAccess</code><p class="">(I am so lazy, i chose full access. NOT RECOMMENDED)</p><p class="">Better mindset is least privilege access, target spec resource arn instead. (go Step 4)</p></li></ol></li></ol></li></ol><ol type="1" class="numbered-list" start="5"><li>Done!</li></ol><p class="">
</p><h1 class="">Step 3: API Gateway Setup</h1><ol type="1" class="numbered-list" start="1"><li>API Gateway &gt; Create API and choose <strong>REST API</strong> type.</li></ol><ol type="1" class="numbered-list" start="2"><li>Give a name and it’s just a name. Do not let it bother you.</li></ol><ol type="1" class="numbered-list" start="3"><li>Create your resources (URL paths).<ol type="a" class="numbered-list" start="1"><li>Create methods (GET, POST, etc.).</li></ol><ol type="a" class="numbered-list" start="2"><li>Attach your Lambda function.<p class="">click <mark class="highlight-red"><strong>Lambda proxy integration</strong></mark>(Send the request to your Lambda function as a structured event.) or it will get <mark class="highlight-red"><strong>undefined method</strong></mark> in lambda context.</p><p class="">or if already created but still get undefined method, go resources &gt; endpoint &gt; method, there’s a <strong>Integration request tab &gt; Edit, turn on </strong><mark class="highlight-red"><strong>Lambda proxy integration</strong></mark></p></li></ol></li></ol><ol type="1" class="numbered-list" start="4"><li>Set up your responses.</li></ol><p class="">
</p><p class="">.. repeat above if you need multiple endpoints or methods</p><p class="">
</p><ol type="1" class="numbered-list" start="5"><li>then last thing Deploy API to a stage (dev, prod).<p class="">stage it’s like a little versioning and target environment</p><p class="">you can have dev stage, production stage, v1, etc</p></li></ol><ol type="1" class="numbered-list" start="6"><li>To get the API endpoint, go Stage &gt; Choose Stage to get  <strong>Invoke URL</strong> for your client usage.</li></ol><ol type="1" class="numbered-list" start="7"><li>now connection between Lambda and API Gateway done.</li></ol><p class="">
</p><p class="">
</p><h1 class="">Step 4: Lambda can access DynamoDB now!</h1><ol type="1" class="numbered-list" start="1"><li><mark class="highlight-blue"><strong>Lambda</strong></mark> function &gt; Configuration tab</li></ol><ol type="1" class="numbered-list" start="2"><li>Permissions section and find the Role name.</li></ol><ol type="1" class="numbered-list" start="3"><li>Click on that role name. This&#x27;ll take you straight to <mark class="highlight-blue"><strong>IAM</strong></mark>.</li></ol><ol type="1" class="numbered-list" start="4"><li>Now, in <mark class="highlight-blue"><strong>IAM</strong></mark>, we&#x27;re gonna add some new permissions to this role.<ol type="a" class="numbered-list" start="1"><li>If you want to play it safe, you can set it up so <mark class="highlight-blue"><strong>Lambda</strong></mark> can only access that specific <mark class="highlight-blue"><strong>DynamoDB</strong></mark> table. You&#x27;ll need to use the table&#x27;s ARN for this.</li></ol><ol type="a" class="numbered-list" start="2"><li>If you&#x27;re feeling a bit lazy like me, you can just give it full access to DynamoDB LOL.</li></ol></li></ol><p class="">
</p><p class="">
</p><p class="">Use <mark class="highlight-blue"><strong>DynamoDB</strong></mark> sdk in your lambda functions.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-JavaScript">import { DynamoDBClient } from &quot;@aws-sdk/client-dynamodb&quot;;
import { DynamoDBDocumentClient, PutCommand } from &quot;@aws-sdk/lib-dynamodb&quot;;

const client = new DynamoDBClient({});
const dynamo = DynamoDBDocumentClient.from(client);
const tableName = &quot;expressDB&quot;;


export const handler = async (event) =&gt; {
  try {
    if (event.httpMethod === &#x27;POST&#x27;) {
      await dynamo.send(
        new PutCommand({
          TableName: tableName,
          Item: { // ... },
        })
      );
      return {
			  statusCode,
			  headers,
			  body: JSON.stringify(body)
			}
    } 
    else {
      return createResponse(400, { message: `Unsupported HTTP method: ${event.httpMethod}` });
    }
  } catch (error) {
    console.error(&quot;Error:&quot;, error);
    return createResponse(500, { message: &quot;Internal server error&quot;, error: error.toString() });
  }
};</code></pre><p class="">
</p><p class="">
</p><p class="">
</p><p class="">
</p><p class="">
</p><p class="">
</p><h1 class="">Some Notes</h1><h3 class="">Finding 1</h3><p class="">Why do I still run into CORS issues with Lambda even when I&#x27;ve fully enabled CORS in API Gateway?</p><p class="">Even with CORS enabled in API Gateway, your Lambda function needs to play ball too. Here&#x27;s why:</p><ul class="bulleted-list"><li style="list-style-type:disc">API Gateway&#x27;s CORS settings mainly handle preflight (OPTIONS) requests.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">For actual GET, POST, etc., requests, your Lambda needs to send the right CORS headers.</li></ul><p class="">Quick fix</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-JavaScript">// CORS headers
const headers = {
  &#x27;Access-Control-Allow-Origin&#x27;: &#x27;*&#x27;,
  &#x27;Access-Control-Allow-Headers&#x27;: &#x27;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token&#x27;,
  &#x27;Access-Control-Allow-Methods&#x27;: &#x27;OPTIONS,POST,GET&#x27;
};

&quot;
// for every response
return createResponse(200, { message: &quot;Session saved successfully&quot; });</code></pre><p class="">
</p><h3 class="">Thought 2</h3><p class="">When you change something in API Gateway, always remember</p><p class=""><mark class="highlight-red"><strong>&quot;Deploy API&quot;</strong></mark></p><p class="">
</p><p class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body>