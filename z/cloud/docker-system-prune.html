<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>brutal solution — docker system prune</title></head><body><article class="page serif"><header><div class="page-header-icon undefined"><img class="icon" src="https://www.notion.so/icons/document_purple.svg"/></div><h1 class="page-title">brutal solution — docker system prune</h1><p class="page-description"></p><table class="properties"><tbody><tr class="property-row property-row-created_by"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesCreatedBy"><path d="M8 15.126C11.8623 15.126 15.0615 11.9336 15.0615 8.06445C15.0615 4.20215 11.8623 1.00293 7.99316 1.00293C4.13086 1.00293 0.938477 4.20215 0.938477 8.06445C0.938477 11.9336 4.1377 15.126 8 15.126ZM8 10.4229C6.05176 10.4229 4.54785 11.1133 3.83008 11.9131C2.90039 10.9082 2.33301 9.55469 2.33301 8.06445C2.33301 4.91992 4.84863 2.39746 7.99316 2.39746C11.1377 2.39746 13.6738 4.91992 13.6738 8.06445C13.6738 9.55469 13.1064 10.9082 12.1699 11.9131C11.4521 11.1133 9.94824 10.4229 8 10.4229ZM8 9.30176C9.32617 9.30859 10.3516 8.18066 10.3516 6.71094C10.3516 5.33008 9.31934 4.18164 8 4.18164C6.6875 4.18164 5.6416 5.33008 5.64844 6.71094C5.65527 8.18066 6.68066 9.28809 8 9.30176Z"></path></svg></span>Created by</th><td><span class="user"><img src="brutal%20solution%20%E2%80%94%20docker%20system%20prune%20350b5b69922b41b2951d13ad293a4e46/IMG_2295.jpg" class="icon user-icon"/>JiaLin Huang</span></td></tr><tr class="property-row property-row-last_edited_time"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesCreatedAt"><path d="M8 15.126C11.8623 15.126 15.0615 11.9336 15.0615 8.06445C15.0615 4.20215 11.8623 1.00293 7.99316 1.00293C4.13086 1.00293 0.938477 4.20215 0.938477 8.06445C0.938477 11.9336 4.1377 15.126 8 15.126ZM8 13.7383C4.85547 13.7383 2.33301 11.209 2.33301 8.06445C2.33301 4.91992 4.84863 2.39746 7.99316 2.39746C11.1377 2.39746 13.6738 4.91992 13.6738 8.06445C13.6738 11.209 11.1445 13.7383 8 13.7383ZM4.54102 8.91211H7.99316C8.30078 8.91211 8.54004 8.67285 8.54004 8.37207V3.8877C8.54004 3.58691 8.30078 3.34766 7.99316 3.34766C7.69238 3.34766 7.45312 3.58691 7.45312 3.8877V7.83203H4.54102C4.2334 7.83203 4.00098 8.06445 4.00098 8.37207C4.00098 8.67285 4.2334 8.91211 4.54102 8.91211Z"></path></svg></span>Last edited</th><td><time>@2024年9月29日 9:58</time></td></tr><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesMultipleSelect"><path d="M1.91602 4.83789C2.44238 4.83789 2.87305 4.40723 2.87305 3.87402C2.87305 3.34766 2.44238 2.91699 1.91602 2.91699C1.38281 2.91699 0.952148 3.34766 0.952148 3.87402C0.952148 4.40723 1.38281 4.83789 1.91602 4.83789ZM5.1084 4.52344H14.3984C14.7607 4.52344 15.0479 4.23633 15.0479 3.87402C15.0479 3.51172 14.7607 3.22461 14.3984 3.22461H5.1084C4.74609 3.22461 4.45898 3.51172 4.45898 3.87402C4.45898 4.23633 4.74609 4.52344 5.1084 4.52344ZM1.91602 9.03516C2.44238 9.03516 2.87305 8.60449 2.87305 8.07129C2.87305 7.54492 2.44238 7.11426 1.91602 7.11426C1.38281 7.11426 0.952148 7.54492 0.952148 8.07129C0.952148 8.60449 1.38281 9.03516 1.91602 9.03516ZM5.1084 8.7207H14.3984C14.7607 8.7207 15.0479 8.43359 15.0479 8.07129C15.0479 7.70898 14.7607 7.42188 14.3984 7.42188H5.1084C4.74609 7.42188 4.45898 7.70898 4.45898 8.07129C4.45898 8.43359 4.74609 8.7207 5.1084 8.7207ZM1.91602 13.2324C2.44238 13.2324 2.87305 12.8018 2.87305 12.2686C2.87305 11.7422 2.44238 11.3115 1.91602 11.3115C1.38281 11.3115 0.952148 11.7422 0.952148 12.2686C0.952148 12.8018 1.38281 13.2324 1.91602 13.2324ZM5.1084 12.918H14.3984C14.7607 12.918 15.0479 12.6309 15.0479 12.2686C15.0479 11.9062 14.7607 11.6191 14.3984 11.6191H5.1084C4.74609 11.6191 4.45898 11.9062 4.45898 12.2686C4.45898 12.6309 4.74609 12.918 5.1084 12.918Z"></path></svg></span>Tags</th><td><span class="selected-value select-value-color-purple">Post</span><span class="selected-value select-value-color-yellow">docker</span></td></tr></tbody></table></header><div class="page-body"><h1 class="">WHY</h1><p class="">Sometimes Dockerfiles have too many layers or remote dependencies (e.g., <code>ADD</code>), making it difficult to identify which layer is causing problems. This is especially annoying when some behaviors come from remote sources.</p><p class="">
</p><p class="">When you&#x27;re waiting for JUST the final <code>CMD</code> to start development, but find that rebuilding the Docker image doesn&#x27;t help, it can be frustrating. It&#x27;s even more frustrating when you can&#x27;t recognize the numerous untagged images when using the image command.<br/>If a build takes 10-15 minutes and still fails, it becomes extremely frustrating. <br/></p><p class=""><mark class="highlight-red"><strong>In such cases, a brute way can be very nice.</strong></mark></p><h1 class="">dangling image v.s. unused image</h1><ol type="1" class="numbered-list" start="1"><li>Unused: Images <mark class="highlight-red"><strong>NOT USED</strong></mark> by <strong>any container, including stopped containers.</strong></li></ol><ol type="1" class="numbered-list" start="2"><li>Dangling: Images that exist but have no tag or name.<blockquote class="">On the other hand, a <strong>dangling</strong> image just means that you&#x27;ve created the new build of the image, but it wasn&#x27;t given a new name. So the old images you have becomes the  dangling image&quot;. Those old image are the ones that are untagged and displays &quot;<code>&lt;none&gt;</code>&quot; on its name when you run <code>docker images</code>.</blockquote></li></ol><p class="">
</p><p class=""><strong>dangling images is unused images</strong></p><p class=""><mark class="highlight-red"><strong>Unused images are not necessarily dangling images.</strong></mark></p><p class="">
</p><h1 class="">docker system prune</h1><p class="">REMOVE:</p><ul class="bulleted-list"><li style="list-style-type:disc">Stopped containers</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Unused networks</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Dangling images</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Dangling build cache</li></ul><p class="">
</p><p class="">
</p><h1 class="">docker system prune -a</h1><p class="">In addition to the <code>docker system prune</code>, it <mark class="highlight-red"><strong>also removes</strong></mark>:</p><ul class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-red"><strong>Unused images</strong></mark></li></ul><p class="">
</p><h1 class="">docker system prune --volumes</h1><p class="">In addition to the <code>docker system prune</code>, it <mark class="highlight-red"><strong>also removes</strong></mark>:</p><ul class="bulleted-list"><li style="list-style-type:disc">Unused volumes<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-Bash">docker system prune --volumes
# - Deleted Containers
# - Deleted Networks
# - Deleted Volumes
# - Deleted Images
# - Deleted build cache objects</code></pre></li></ul><p class="">
</p><p class="">
</p><p class="">
</p><h1 class="">docker-compose down -v --rmi local</h1><p class="">Removes containers, networks, volumes, and local images within the scope of the docker-compose.yml file. <mark class="highlight-red"><strong>Local means it only removes images built locally,</strong></mark> not those pulled from remote repositories.</p><p class="">
</p><h1 class="">docker system prune vs docker builder prune</h1><p class="">only discuss builder here.</p><p class=""><code><strong>docker builder prune</strong></code><strong> is more </strong><mark class="highlight-red"><strong>broader</strong></mark><strong> and includes:</strong></p><ol type="1" class="numbered-list" start="1"><li>unused builder cache</li></ol><ol type="1" class="numbered-list" start="2"><li>unused Intermediate Image Layers (part of builder cache)<ul class="bulleted-list"><li style="list-style-type:disc"><code>docker system prune</code> only delete dangling</li></ul><ul class="bulleted-list"><li style="list-style-type:disc"><code>docker builder prune</code> builder is more thorough. DELETE ALL.</li></ul></li></ol><ol type="1" class="numbered-list" start="3"><li>Other build-related cache data (source code cache, dependency download cache, temporary files generated during compilation, unused stage results in multi-stage builds)</li></ol><p class="">
</p><p class="">
</p><h3 class="">Intermediate Image Layers (IIL) and  Builder Cache</h3><p class=""><strong>Intermediate Image Layers (IIL)</strong> are actual layers that make up the final image. Each instruction in a Dockerfile typically creates an IIL.</p><p class=""><strong>Builder cache</strong> has a broader scope and includes IILs as well as other data not part of image layers.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-Docker">FROM ubuntu:20.04
RUN apt-get update &amp;&amp; apt-get install -y python3
COPY ./app /app
RUN pip install -r /app/requirements.txt
CMD [&quot;python3&quot;, &quot;/app/main.py&quot;]</code></pre><p class="">
</p><p class="">
</p><p class="">Use <code>docker history &lt;image_name&gt;</code> will know that </p><p class=""><mark class="highlight-red"><strong>each instruction in a Dockerfile typically creates an IIL</strong></mark></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-Docker">IMAGE          CREATED        CREATED BY                                      SIZE
abc123def456   2 minutes ago  CMD [&quot;python3&quot; &quot;/app/main.py&quot;]                  0B
789ghi101112   2 minutes ago  RUN /bin/sh -c pip install -r /app/require...   10MB
jklmno131415   2 minutes ago  COPY ./app /app # buildkit                      5MB
pqrstu161718   3 minutes ago  RUN /bin/sh -c apt-get update &amp;&amp; apt-get i...   100MB</code></pre><blockquote class=""><strong>Builder cache has a broader scope</strong> and includes IILs as well as other data not part of image layers.</blockquote><p class="">
</p><p class="">
</p><p class=""><a href="https://stackoverflow.com/questions/30604846/docker-error-no-space-left-on-device/56147993#56147993">https://stackoverflow.com/questions/30604846/docker-error-no-space-left-on-device/56147993#56147993</a></p><p class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body>